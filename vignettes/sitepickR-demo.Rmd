---
title: "sitepickR-demo: CCD data for California 2017-18"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sitepickR-demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
options(rmarkdown.html_vignette.check_title = FALSE) 
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.width=7, fig.height=5) 
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(sitepickR)
```
## Load data:

Load the CCD-California 2017-18 sample dataset that comes installed with the package:

```{r}
dfCCD <- sitepickR::dfCCD
head(dfCCD)
```

If you 'll want to write the two main results into a .csv file, specify a preferred local folder path and two separate filenames, one for each output directory:

```{r}
PATH = "SOME-USER-FOLDER/" 
replDISTRICTS = paste0(PATH, "/replacementUnits.csv") # {initial district:[replacements]} directory
dictSCHOOLS = paste0(PATH, "/subUnitTable.csv") # {district: [schools]} directory
```

## Define key input values:

Since there are underlying random sampling procedures, set a seed for replication purposes (optional)
```{r}
seed = 1234 
```

Specify district level covariates on which to match selected districts with non-selected alternatives:
```{r}
unitSamp_varsCCD <- c("w.pct.frlunch", "w.pct.black", "w.pct.hisp", "w.pct.female") 
```
Specify school level covariates on which to match districts:
```{r}
subUnitSamp_varsCCD <- c("sch.pct.frlunch", "sch.pct.black", "sch.pct.hisp", "sch.pct.female")
```
Specify covariates on which to _exactly_ match districts (these would usually be categorical):
```{r}
exact_match_vars <-  c("distr.type")
```
Specify covariates on which to match districts within a given caliper (these would be numeric):
```{r}
calip_match_vars <-  c("w.pct.black", "w.pct.hisp", "w.pct.female")
```

## Run selectMatch()

We'll match districts using Mahalanobis distance (we can also do this using propensity scores, as specified in the documentation):

```{r}

m.out <- selectMatch(df=dfCCD, # dataset
                       unit_ID="LEAID", # column name of district ID
                       subUnit_ID="NCESSCH", # column name of school ID
                       unit_vars=unitSamp_varsCCD,
                       subUnit_samp_vars=subUnitSamp_varsCCD,
                       exact_match_vars=NULL,
                       calip_match_vars=calip_match_vars , 
                       nUnitSamp = 100, # original district sample size
                       nRepUnits = 10, # number of desired matches per selected district
                       nsubUnits = 5, # number of schools to sample from each candidate district
                       calipValue = 0.2, # 
                       seedN = seed,
                       matchDistance = "mahalanobis",
                       sizeFlag = TRUE,
                       replaceFlag = FALSE, #match without replacement
                       writeOut = FALSE, # write out a csv file for: 1) matched units and 2) selected schools
                       replacementUnitsFilename = replDISTRICTS,
                       subUnitTableFilename = dictSCHOOLS
)
```


## Balance diagnostics

By default, balance diagnostics in sitepickR are expressed in terms of standardize Mean difference (SMD) between two comparison groups --in this case, selected districts or schools against population, or against the originally selectd units.

 1. Balance against population: originally selected vs. all districts:

```{r fig.width=5, fig.height=5}
getUnitLovePlot(m.out)
```

2. Balance against originally selected district: each originally selected district vs. its K replacement districts groups (ordered in terms of covariate similarity):

```{r}
getUnitReplacementBalance(m.out)
```

 3. Percentage of successfully computed matches for the original districts in each of their  1-K replacements groups (ordered in terms of covariate similarity) 

```{r}
getMatchCount(m.out)
```

4. Balance against all schools from originally selected district: schools from each originally selected district vs. schools from their respective K replacement districts groups (ordered in terms of covariate similarity):

```{r}
getSubUnitBalance(m.out)
```
