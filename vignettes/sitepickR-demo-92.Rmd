---
title: "sitePickR: Getting Started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sitepickR-demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
options(rmarkdown.html_vignette.check_title = FALSE) 
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.width=7, fig.height=5) 
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Sampling AY 2017-18 California schools and districts

__Robert Olsen, Elizabeth A. Stuart & Elena Badillo-Goicoechea__

2022-09-01

## Introduction

sitepickR is designed to select a representative sample of sites for a prospective impact evaluation, such as a randomized controlled trial (RCT). 

Like [generalizeR](https://nustat.github.io/generalizeR/), this package is designed for selecting schools but can be used to select any type of site defined by geography or administrative responsibility (e.g., county, job training center, health clinic). Unlike generalizeR, sitepicker is designed to select sites in two stages —first “units” that contain multiple sites located nearby and/or under the same administration and then “subunits” containing individual sites. Two-stage sampling may be necessary when the cost of the study depend on the number of units (e.g., school districts), and a one-stage sample of subunits (e.g., schools) would likely contain more units than the study can afford.

The main function in this package, [selectMatch()](vignettes/selectMatch.html) lets the user carry out a two-level sample selection where the possibility of an initially selected participant not wanting to participate is anticipated. The procedure aims to reduce the bias (and/or loss of generalizability to the population) this could introduce.

In selecting units and subunits, sitepickR uses the cube method (e.g., Deville & Tillé, 2004; Tillé 2011). The cube method is a probability sampling method that is designed to satisfy criteria for balance between the sample and the population. Recent research has shown that this method performs well in simulations for studies of educational programs (Fay & Olsen, under review). To implement the cube method, sitepickerR uses the [sampling](https://cran.r-project.org/web/packages/sampling/index.html) R package. Users have the option to select units with equal probabilities or with probabilities proportional to their “size” measured in terms of the number of subunits nested within units.


In addition, sitepickR uses statistical matching to select possible replacement units. In education RCTs, the share of selected districts that agrees to participate tends to be low. To address this challenge, sitepickR selects and ranks up to 10 replacement districts for each districts selected using the cube method. Replacement districts are selected using statistical matching based on propensity score methods. To implement statistical matching, sitepickR uses the [MatchIt](https://cran.r-project.org/web/packages/MatchIt/vignettes/MatchIt.html) R package.


sitepickR's sampling + matching procedure consists on five steps: 1) identifying a target population with a nested structure (e.g. [unit:subunit]), 2) randomly selecting an initial sample of units from the target population, 3) obtaining a list of 'best' potential replacements for each initially selected unit, in terms of the unit-level covariates of interest; 4) assessing the quality of the replacements in terms of their similarity to their original counterparts, and 5) assessing the balance of each replacement group against the target population, in terms of available covariates of interest. 

This vignette guides the reader, using a pre-processed dataset with data from the [Common Core of Data (CCD)]()  for California schools (2017-18), on how to use sitepickR's main functionality, step-by-step. Technical details are included in the documentation.

First, if needed, install the sitepickR package with the help of devtools, and load it:

```{r}

if(!require(devtools)){
  install.packages("devtools")
}

if(!require(sitepickR)){
 devtools::install_github("ElenaBadilloG/sitepickR")
}


library(sitepickR)


```
## Load data and set basic inputs:

Load the pre-processed [CCD dataset](), which is included with the package installation:

```{r}
dfCCD <- sitepickR::dfCCD
head(dfCCD)
```

If you 'll want to write the two main results into a .csv file, specify a preferred local folder path and two separate filenames, one for each output directory:

```{r}
PATH = "SOME-PREFERRED-FOLDER/" 
replDISTRICTS = paste0(PATH, "/replacementUnits.csv") # {initial district:[replacements]} directory
dictSCHOOLS = paste0(PATH, "/subUnitTable.csv") # {district: [schools]} directory
```

## Study design:

Specify district level covariates on which to match selected districts with non-selected alternatives. In this example we'll include: 1) percentage of students who are under free/reduced price lunch program, 2) percentage of students in the school district who are Black, 3) percentage of students in the school district who are Hispanic, 4) percentage of students in the school district who are female.

```{r}
unitSamp_varsCCD <- c("w.pct.frlunch", "w.pct.black", "w.pct.hisp", "w.pct.female") 
```

Specify school level covariates on which to match districts with their potential replacements:
```{r}
subUnitSamp_varsCCD <- c("sch.pct.frlunch", "sch.pct.black", "sch.pct.hisp", "sch.pct.female")
```
Specify covariates on which to _exactly_ match districts (these would usually be categorical). In our example, we'll use "district type":
```{r}
exact_match_vars <-  c("distr.type")
```
Specify covariates on which to match districts within a given caliper (these would be numeric):
```{r}
calip_match_vars <-  c("w.pct.black", "w.pct.hisp", "w.pct.female")
```

## Set key input values:

Since there will be some underlying random sampling procedures, you may want to set a seed for replication purposes (optional):

```{r}
 seedN = 1234 
 unit_vars=unitSamp_varsCCD
 subUnit_samp_vars=subUnitSamp_varsCCD
 exact_match_vars=NULL
 calip_match_vars=calip_match_vars # numeric covariates contrained to be within a maximum given distance
 nUnitSamp = 100 # original district sample size
 nRepUnits = 10 # number of desired matches per selected district
 nsubUnits = 5 # number of schools to sample from each candidate district
 calipValue = 0.2 # maximum distance (in terms of ansolute SMD) allowed for calip_match_vars
 seedN = 1234
 matchDistance = "mahalanobis" 
 sizeFlag = TRUE # conduct initial district sampling proportional to its number of schools 
 replaceFlag = FALSE # match districts without replacement
 writeOut = FALSE # write out a csv file for: 1) matched units and 2) selected schools
 replacementUnitsFilename = replDISTRICTS # filename for {unit:replacement} directory
 subUnitTableFilename = dictSCHOOLS # filename for final {unit:school} directory

```

## Run selectMatch()

selectMatch will take care of implementing both stages (initial sampling and unit matching) in one pass:

```{r}

m.out <- selectMatch(df=dfCCD, # dataset
                       unit_ID="LEAID", # column name of district ID
                       subUnit_ID="NCESSCH", # column name of school ID
                       unit_vars=unitSamp_varsCCD,
                       subUnit_samp_vars=subUnitSamp_varsCCD,
                       exact_match_vars,
                       calip_match_vars, 
                       nUnitSamp, # original district sample size
                       nRepUnits, # number of desired matches per selected district
                       nsubUnits, # number of schools to sample from each candidate district
                       calipValue, # maximum SMD for calip_match_vars
                       seedN, # seed number
                       matchDistance,
                       sizeFlag, # conduct initial district sampling proportional to its number of schools 
                       replaceFlag, # match districts without replacement
                       writeOut, # write out a csv file for: 1) matched units and 2) selected schools
                       replacementUnitsFilename,
                       subUnitTableFilenam
)
```


## Balance diagnostics

By default, balance diagnostics in sitepickR are expressed in terms of standardize Mean difference (SMD) between two comparison groups --in this case, selected districts or schools against population, or against the originally selectd units.

### 1. Balance against population: originally selected vs. all districts:

```{r fig.width=5, fig.height=5}
getUnitLovePlot(m.out)
```

### 2. Balance against originally selected district: each originally selected district vs. its K replacement districts groups (ordered in terms of covariate similarity):

```{r}
getUnitReplacementBalance(m.out)
```

### 3. Percentage of successfully computed matches for the original districts in each of their  1-K replacements groups (ordered in terms of covariate similarity) 

```{r}
getMatchCount(m.out)
```

### 4. Balance against all schools from originally selected district: schools from each originally selected district vs. schools from their respective K replacement districts groups (ordered in terms of covariate similarity):

```{r}
getSubUnitBalance(m.out)
```
